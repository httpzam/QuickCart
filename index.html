<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuickCart Scanner</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
  html,body{height:100%;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;overflow-x:hidden}
  body{display:flex;flex-direction:column}
  header,footer{background:#fff;text-align:center;padding:12px 20px;box-shadow:0 2px 4px rgba(0,0,0,.1);flex-shrink:0;z-index:10}
  header h3{margin:0;font-size:1.2rem}
  
  button{cursor:pointer;padding:10px 18px;border:1px solid #ccc;border-radius:8px;background:#e9e9e9;font-weight:700}
  button:hover{background:#ddd}

  #scanner-container{flex-grow:1;display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box}
  .video-wrapper{
    position:relative;width:90vw;max-width:500px;aspect-ratio:1/1;
    border:2px solid #ccc;border-radius:12px;overflow:hidden;background:#000;
    box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;justify-content:center;align-items:center
  }
  video{width:100%;height:100%;object-fit:cover;display:block}

  .laser-line{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#ff3b30,transparent);box-shadow:0 0 8px #ff3b30;animation:laserScan 2.5s infinite ease-in-out;pointer-events:none}
  @keyframes laserScan{0%,100%{top:10%}50%{top:90%}}

  .popup-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;padding:15px;box-sizing:border-box;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
  .popup-content{background:#fff;padding:25px;border-radius:12px;max-width:400px;width:100%;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.2)}

  #popup-details{display:flex;flex-direction:column;gap:15px;margin-bottom:20px;text-align:left}
  .popup-row{display:flex;justify-content:space-between;align-items:center;gap:5px;flex-wrap:wrap;font-size:clamp(.9rem,2.5vw,1.2rem)}
  .popup-row input[type="number"]{width:70px;padding:8px;border:1px solid #ccc;border-radius:5px;text-align:center;font-size:1.1rem}

  #popup-actions{display:flex;justify-content:flex-end;gap:10px}
  #popup-actions .add-btn{background:#007aff;color:#fff;border:none}

  #not-found-popup .popup-content{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}

  footer{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
  .cart-button-wrapper{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.1rem}
  .cart-button{background:none;border:none;position:relative;padding:5px}

  .badge{position:absolute;top:-5px;right:-8px;background:#ff3b30;color:#fff;padding:2px 6px;font-size:.8rem;border-radius:50%;border:2px solid #fff}

  #subtotal{font-size:clamp(1rem,3vw,1.2rem)}
  #scan-status{text-align:center;padding:5px;color:#d9534f;font-weight:700}

  .focus-circle{position:absolute;width:80px;height:80px;border-radius:50%;border:2px solid #fff;transform:translate(-50%,-50%) scale(1);pointer-events:none;opacity:0;transition:opacity .25s,transform .25s;box-shadow:0 0 12px rgba(0,0,0,.6);z-index:50}
  .focus-circle.show{opacity:1;transform:translate(-50%,-50%) scale(1.05);border-color:#00d1b2}

  .tap-hint{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:40;color:#fff;text-shadow:0 0 8px rgba(0,0,0,.7);font-size:.95rem;background:rgba(0,0,0,.25);padding:6px 10px;border-radius:999px}

  /* Flip camera inside box */
  .flip-btn-box{
    position:absolute;
    top:10px;
    right:10px;
    z-index:60;
  }

  #flip-btn{
    width:40px;
    height:40px;
    border:none;
    border-radius:50%;
    background:rgba(0,0,0,0.35);
    backdrop-filter:blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.2s;
    padding:0;
  }

  #flip-btn:hover{background:rgba(0,0,0,0.55)}

  #flip-btn img{
    width:20px;
    filter:brightness(1000%);
    pointer-events:none;
  }
</style>
</head>
<body>

<header><h3>QuickCart Scanner</h3></header>

<div id="scanner-container">
  <div class="video-wrapper">
    <video id="scanner" autoplay muted playsinline></video>
    <div class="laser-line"></div>
    <div id="focusCircle" class="focus-circle"></div>
    <div class="tap-hint">Tap-tap to focus the camera</div>

    <div class="flip-btn-box">
      <button id="flip-btn" title="Switch Camera">
        <img src="https://img.icons8.com/ios-filled/50/ffffff/switch-camera.png" />
      </button>
    </div>

  </div>
</div>

<div id="scan-status"></div>

<!-- Product Popup -->
<div id="popup" class="popup-overlay">
  <div class="popup-content">
    <div id="popup-details">
      <div class="popup-row"><span>Description:</span><span id="popup-description"></span></div>
      <div class="popup-row"><span>Unit Price:</span><span id="popup-price"></span></div>
      <div class="popup-row"><label for="popup-qty">Quantity:</label><input type="number" id="popup-qty" value="1" min="1"></div>
    </div>
    <div id="popup-actions">
      <button onclick="closePopup()">Cancel</button>
      <button class="add-btn" onclick="addToCart()">Add to Cart</button>
    </div>
  </div>
</div>

<!-- Not Found -->
<div id="not-found-popup" class="popup-overlay">
  <div class="popup-content"><p>Product not found.</p><button onclick="closeNotFound()">OK</button></div>
</div>

<footer>
  <div class="cart-button-wrapper">
    <span>Cart</span>
    <button onclick="goToCart()" class="cart-button">
      <img src="https://img.icons8.com/ios-filled/50/000000/shopping-cart.png" width="28" />
      <span id="cart-count" class="badge">0</span>
    </button>
  </div>
  <div>Subtotal: <span id="subtotal">â‚±0.00</span></div>
</footer>

<audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

<script>
/* ============================
   POPUP + CART LOGIC
============================= */
const popup = document.getElementById("popup");
const notFoundPopup = document.getElementById("not-found-popup");
const popupDescription = document.getElementById("popup-description");
const popupPrice = document.getElementById("popup-price");
const popupQty = document.getElementById("popup-qty");
const beepSound = document.getElementById("beep-sound");
const scanStatus = document.getElementById("scan-status");
const focusCircle = document.getElementById("focusCircle");
const video = document.getElementById("scanner");
const flipBtn = document.getElementById("flip-btn");

let currentProduct = null;

function showPopup(product){
  currentProduct = product;
  popupDescription.textContent = product.name;
  popupPrice.textContent = "â‚±" + product.price;
  popupQty.value = 1;
  popup.style.display = "flex";
  try { beepSound.currentTime = 0; beepSound.play(); } catch(_) {}
}
function closePopup(){ popup.style.display = "none"; }
function showNotFound(){ notFoundPopup.style.display = "flex"; }
function closeNotFound(){ notFoundPopup.style.display = "none"; }

function addToCart(){
  const qty = parseInt(popupQty.value);
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  const existing = cart.find(i => i.barcode === currentProduct.barcode);
  if(existing) existing.qty += qty; else cart.push({...currentProduct, qty});
  localStorage.setItem("cart", JSON.stringify(cart));
  closePopup(); updateCartDisplay();
}

function updateCartDisplay(){
  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const count = cart.reduce((s,i)=> s + i.qty, 0);
  const subtotal = cart.reduce((s,i)=> s + (i.price * i.qty), 0);
  document.getElementById("cart-count").textContent = count;
  document.getElementById("subtotal").textContent = "â‚±" + subtotal.toFixed(2);
}

function goToCart(){
  stopScanner();
  window.location.href = "cart.php";
}

/* ============================
   CAMERA LOGIC + FLIP CAMERA
============================= */

let codeReader = null;
let stream = null;
let scanning = false;
let videoInputs = [];
let currentVideoIndex = 0;

document.addEventListener("DOMContentLoaded", () => {
  updateCartDisplay();
  initScanner();
  flipBtn.addEventListener("click", toggleCamera);
});

async function initScanner(){
  try {
    codeReader = new ZXing.BrowserMultiFormatReader();

    const devices = await navigator.mediaDevices.enumerateDevices();
    videoInputs = devices.filter(d => d.kind === "videoinput");

    let backIndex = videoInputs.findIndex(d => /back|rear|environment/i.test(d.label));
    if(backIndex === -1 && videoInputs.length) backIndex = videoInputs.length - 1;

    currentVideoIndex = backIndex !== -1 ? backIndex : 0;

    await startScanner();
  } catch (e) {
    scanStatus.innerText = "Camera initialization failed.";
  }
}

async function startScanner(){
  stopScanner();

  if(videoInputs.length === 0){
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoInputs = devices.filter(d => d.kind === "videoinput");
  }

  if(videoInputs.length === 0){
    scanStatus.innerText = "No camera detected.";
    return;
  }

  const chosen = videoInputs[currentVideoIndex];

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        deviceId: chosen.deviceId,
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
  } catch {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
  }

  video.srcObject = stream;
  await video.play();

  scanStatus.innerText = "";

  /* ðŸ”¥ FIXED WORKING ZXING DECODER */
  codeReader.decodeFromVideoDevice(
    chosen.deviceId,
    video,
    async (result, err) => {

      if (err && !(err instanceof ZXing.NotFoundException)) return;
      if (!result || scanning) return;

      scanning = true;
      const barcode = result.text;

      try { beepSound.currentTime = 0; beepSound.play(); } catch (_) {}

      await fetchProduct(barcode);
      setTimeout(() => scanning = false, 1400);
    }
  );
}

function stopScanner(){
  try{
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    if(codeReader) codeReader.reset();
  }catch(_){}
}

async function toggleCamera(){
  if(videoInputs.length === 0){
    const devices = await navigator.mediaDevices.enumerateDevices();
    videoInputs = devices.filter(d => d.kind === "videoinput");
  }

  currentVideoIndex = (currentVideoIndex + 1) % videoInputs.length;

  scanStatus.innerText = "Switching camera...";
  await startScanner();
  setTimeout(()=> scanStatus.innerText = "", 800);
}

document.addEventListener("visibilitychange", () => {
  if(document.visibilityState === "visible"){
    startScanner();
  } else {
    stopScanner();
  }
});

/* TAP TO FOCUS */
document.querySelector('.video-wrapper').addEventListener('click', async (ev) => {
  const rect = ev.currentTarget.getBoundingClientRect();
  const x = ev.clientX - rect.left;
  const y = ev.clientY - rect.top;

  focusCircle.style.left = `${x}px`;
  focusCircle.style.top = `${y}px`;
  focusCircle.classList.remove('show');
  void focusCircle.offsetWidth;
  focusCircle.classList.add('show');
  setTimeout(()=> focusCircle.classList.remove('show'), 700);
});

/* FETCH PRODUCT */
async function fetchProduct(barcode){
  try {
    const response = await fetch(`https://quickkcart.42web.io/get-products.php?barcode=${encodeURIComponent(barcode)}`);
    const data = await response.json();
    if(data.success && data.product) showPopup(data.product);
    else showNotFound();
  } catch(err){
    scanStatus.innerText = "âš ï¸ Cannot connect.";
    setTimeout(()=> scanStatus.innerText="", 3000);
  }
}
</script>

</body>
</html>
